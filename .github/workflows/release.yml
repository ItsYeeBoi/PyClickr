name: Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  release:
    name: Semantic release
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install python-semantic-release

      - name: Semantic Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release version
          semantic-release changelog
          semantic-release publish

      - name: Determine release tag
        id: tag
        run: |
          # Get the tag that points at the current HEAD (the version bump commit)
          TAG=$(git tag --points-at HEAD | head -n 1 || true)
          echo "Release tag: $TAG"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

  windows-exe:
    name: Build Windows EXE and upload
    needs: release
    # Only run if a new tag was actually created
    if: needs.release.outputs.tag != ''
    runs-on: windows-latest

    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyinstaller

      - name: Build with PyInstaller (spec)
        shell: bash
        run: |
          if [ -f "PyClickr.spec" ]; then
            pyinstaller "PyClickr.spec"
          elif [ -f "pyclickr.spec" ]; then
            pyinstaller "pyclickr.spec"
          else
            echo "No spec found; falling back to onefile build"
            pyinstaller --onefile --windowed --name PyClickr src/pyclickr/app.py
          fi

      - name: Locate EXE path
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path dist -Filter *.exe -Recurse | Select-Object -First 1
          if (-not $exe) { Write-Error "No EXE found in dist/*"; exit 1 }
          "OUT=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "OUT_BASENAME=$($exe.Name)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "Found EXE: $($exe.FullName)"

      - name: Upload EXE to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag }}
          files: ${{ env.OUT }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
